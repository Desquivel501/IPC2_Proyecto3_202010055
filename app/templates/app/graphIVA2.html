{% extends 'app/graph.html' %}

{% block contenedor %}

<div class="row align-items-center">
    <div class="col">
        <form>
          {% csrf_token %}
            <div class="mb-3">
                <h3>Resumen de IVA por fecha y NIT</h3>
                <hr>

              <!-- <label for="nit" class="form-label">NIT</label>
              <input type="text" class="form-control" id="nit"> -->
            </div>

            <div class="form-group" id="Seleccionar"></div>

            <div class="mb-3">
                <label for="FechaHasta" class="form-label">Fecha</label>
                <input type="date" id="fecha" placeholder="dd-mm-yyyy" value="" min="1997-01-01" max="2030-12-31" style="width: 50%;">
            </div>

            <button type="submit" class="btn btn-outline-primary" >Generar</button>
            
        </form>
    </div>
    <div class="col">
        <canvas id="myChart"></canvas><br>
        <button type="button" class="btn btn-outline-primary" id ="botonPDF" style="visibility: hidden;" onclick="saveAsPDF();">Generar reporte PDF</button>
    </div>    
</div>  

{% endblock %}

{% block jsblock %}

  <script>
    window.jsPDF = window.jspdf.jsPDF;

    document.addEventListener('submit',function(event){
      event.preventDefault();
      var xValues = [];
      var yValues = [];
      var barColors = [];

      var nit = document.getElementById('selectNit').value 
      var fecha = document.getElementById('fecha').value 
      
      var objeto = {
        "nit":nit,
        "fecha":fecha
      }

      const csrftoken = getCookie('csrftoken')
      console.log(objeto)

      fetch('http://127.0.0.1:8000/getTablaIva2', {
        method: 'POST',
        credentials : 'include',
        body: JSON.stringify(objeto),
        headers:{
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'X-CSRFToken': csrftoken}
      })
        .then(res => res.json())
        .catch(err =>{
            console.log("Ha ocurrido un error");
            alert("Ha ocurrido un error")
        })
          .then(response =>{
            console.log(response)
            if( response.mensaje != "ERROR"){
              xValues = response.xValues
              yValues = response.yValues
              barColors = ["red", "blue"];
  
              new Chart("myChart", {
                type: "bar",
                data: {
                    labels: xValues,
                    datasets: [
                      {
                        backgroundColor: barColors,
                        data: yValues
                      },
                      
                    ]
                },
                options: {
                    legend: {display: false},
                    title: {
                    display: true,
                    text: response.titulo,
                    },
                    resposive: true,
                    scales: {
                      yAxes: [{
                          ticks: {
                              beginAtZero: true
                          }
                      }]
                    }
   
                }
                });

                document.getElementById("botonPDF").style.visibility="visible";
            }else{
              alert("Error")
            }

          
      
        })
    })

    function getNits(){
      var selectForm = document.querySelector('#Seleccionar');
      cadena = ""

      fetch('http://127.0.0.1:5000/getNits', {
      method: 'GET',
      })
      .then(res => res.json())
      .catch(err =>{
          console.log(err);
          alert("Ha ocurrido un error")
      })
        .then(response =>{
          console.log(response)
          cadena+=`
                    <label for="nit" class="form-label">NIT</label>
                    <select class="selectpicker" data-live-search="true" data-live-search-style="startsWith" id="selectNit"> 
                  `
          for(var i in response.Lista){
            cadena += `
                        <option value="${(response.Lista[i])}">${response.Lista[i]}</option>
                      `
            }
            cadena += "</select>"
            selectForm.innerHTML = cadena;
          
      })
    }

    window.onload = getNits()

    </script>
    
{% endblock %}

